# Lead Agent Memory -- SourceMonitor

## Project Quick Facts
- Rails 8 engine, Ruby 3.4+, PostgreSQL-only
- 325 git-tracked Ruby files, 130 test files
- Coverage baseline: 2328 uncovered lines in config/coverage_baseline.json
- RuboCop: rubocop-rails-omakase, config at .rubocop.yml
- CI: .github/workflows/ci.yml (lint, security, test, release-verify, nightly profiling)
- Large files: FeedFetcher (627), Configuration (655), ImportSessionsController (792)

## Phase 1 Findings
- 98 git-tracked .rb files missing frozen_string_literal (out of 325)
- Breakdown: app/(5), lib/(24), test/(43 non-dummy), test/dummy/(22), config/(1), db/migrate/(4)
- test/tmp/ is NOT git-tracked (generated by install_generator tests) -- exclude from changes
- test/lib/tmp/install_generator/config/initializers/source_monitor.rb IS tracked and already has pragma
- bin/rubocop wrapper forces --config .rubocop.yml
- Phase 1 criterion #3 (10% coverage shrink) not addressed by plans 01/02 -- noted for future

## Phase 2 Planning Insights
- Coverage baseline.json has 2117 uncovered lines across 105 files (not 2328 -- that was line count)
- Top 7 files account for ~743 uncovered lines (35% of total)
- FeedFetcher: 245 uncovered, 12 existing tests, uses VCR+WebMock
- ItemCreator: 228 uncovered, 8 existing tests, needs mock entries for Atom/JSON branches
- Configuration: 94 uncovered, 5 existing tests, ~12 nested settings classes
- Dashboard::Queries: 66 uncovered, 7 existing tests, uses raw SQL + Cache
- BulkSourceScraper: 66 uncovered, 6 existing tests, ActiveJob test adapter
- Broadcaster: 48 uncovered, NO existing test file -- needs creation
- SourcesIndexMetrics: 34 uncovered, 3 existing tests
- All 5 Phase 2 plans are Wave 1 (no inter-plan dependencies, no file conflicts)
- Testing main files will indirectly cover supporting files (retry_policy, fetch_error, state, enqueuer, etc.)
- Broadcaster tests need Turbo::StreamsChannel stubs -- no full Action Cable required
- 50% coverage target requires ~1059 lines covered; direct plans target ~630, rest from indirect

## Phase 4 Planning Insights
- 3 plans: conventions-audit (wave 1), item-creator-extraction (wave 1), final-verification (wave 2)
- SourcesController has dead `fetch`/`retry` methods (leftover from Phase 3 CRUD extraction)
- ImportSessionsController `new` and `create` are byte-for-byte identical
- 4 RuboCop violations in db/migrate/20260210204022_add_composite_index_to_log_entries.rb
- Duplicate test: test/controllers/concerns/ vs test/controllers/source_monitor/concerns/
- ItemCreator at 601 lines is the last file over 300 lines -- extract to entry_parser + content_extractor
- Coverage baseline still at 2117 uncovered (not regenerated since Phase 1) -- must regenerate
- 60% reduction target: at most 847 uncovered lines
- dashboard/queries.rb (356) and application_helper.rb (346) are near 300 but acceptable as view/query code
- `bin/update-coverage-baseline` requires `COVERAGE=1 bin/rails test` first

## Bash/Shell Notes
- zsh on macOS -- `!` in shell conditionals causes `command not found` errors
- Use `case` statements instead of `if ! grep` patterns in zsh
- git ls-files piped to while loops works reliably for file enumeration
