#!/usr/bin/env bash
set -euo pipefail

export COVERAGE=true
export SIMPLECOV_COMMAND_NAME="${SIMPLECOV_COMMAND_NAME:-source_monitor:test}"

if [ -d coverage ]; then
  rm -rf coverage
fi

TARGETED_TESTS=(
  "test/lib/source_monitor/health/source_health_check_test.rb"
  "test/lib/source_monitor/health/source_health_monitor_test.rb"
  "test/lib/source_monitor/health/source_health_reset_test.rb"
  "test/lib/source_monitor/health/health_module_test.rb"
  "test/lib/source_monitor/http_test.rb"
  "test/lib/source_monitor/logs/table_presenter_test.rb"
  "test/models/source_monitor/log_entry_test.rb"
  "test/controllers/source_monitor/source_health_checks_controller_test.rb"
  "test/controllers/source_monitor/source_health_resets_controller_test.rb"
  "test/helpers/source_monitor/application_helper_test.rb"
  "test/lib/source_monitor/fetching/stalled_fetch_reconciler_test.rb"
  "test/lib/source_monitor/jobs/fetch_failure_subscriber_test.rb"
  "test/lib/source_monitor/scheduler_test.rb"
  "test/lib/source_monitor/configuration/deprecation_registry_test.rb"
)

run_tests() {
  if command -v rbenv >/dev/null 2>&1; then
    rbenv exec "$@"
  else
    "$@"
  fi
}

run_tests bundle exec rails test "$@"

run_tests_with_env() {
  if command -v rbenv >/dev/null 2>&1; then
    SOURCE_MONITOR_TEST_WORKERS=1 SIMPLECOV_COMMAND_NAME=source_monitor:health_suite COVERAGE=true rbenv exec bundle exec rails test "$@"
  else
    SOURCE_MONITOR_TEST_WORKERS=1 SIMPLECOV_COMMAND_NAME=source_monitor:health_suite COVERAGE=true bundle exec rails test "$@"
  fi
}

run_tests_with_env "${TARGETED_TESTS[@]}"
