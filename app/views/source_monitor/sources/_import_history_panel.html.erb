<% latest = import_histories&.first %>
<div id="source_monitor_import_history_panel">
  <% if latest.present? %>
    <div class="rounded-lg border border-blue-100 bg-blue-50 px-4 py-3 shadow-sm">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-blue-700">Recent OPML import</p>
          <h3 class="text-lg font-semibold text-slate-900">
            Imported <%= latest.imported_count %> • Skipped <%= latest.skipped_count %> • Failed <%= latest.failed_count %>
          </h3>
          <p class="text-sm text-slate-700">
            Completed <%= time_ago_in_words(latest.completed_at || latest.created_at) %> ago.
          </p>
        </div>
        <% if latest.completed? && latest.duration_ms %>
          <div class="text-right text-sm text-slate-600">
            <p>Duration: <%= latest.duration_ms %> ms</p>
          </div>
        <% end %>
      </div>

      <% if latest.failed_sources.present? %>
        <div class="mt-3 overflow-x-auto rounded-md border border-rose-100 bg-white">
          <table class="min-w-full divide-y divide-rose-50 text-left text-sm">
            <thead class="bg-rose-50 text-xs font-semibold uppercase tracking-wide text-rose-700">
              <tr>
                <th scope="col" class="px-3 py-2">Feed URL</th>
                <th scope="col" class="px-3 py-2">Error</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-rose-50 text-rose-800">
              <% Array(latest.failed_sources).each do |failure| %>
                <tr>
                  <td class="px-3 py-2 align-top font-mono text-xs text-slate-800 break-all"><%= failure["feed_url"] || failure[:feed_url] %></td>
                  <td class="px-3 py-2 align-top text-sm">
                    <span class="font-semibold"><%= failure["error_class"] || failure[:error_class] %>:</span>
                    <%= failure["error_message"] || failure[:error_message] %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% elsif latest.skipped_count.positive? %>
        <p class="mt-2 text-sm text-slate-700">Skipped duplicates: <%= latest.skipped_count %>.</p>
      <% end %>
    </div>
  <% else %>
    <div class="rounded-lg border border-slate-200 bg-white px-4 py-3 text-sm text-slate-600">
      No recent OPML imports.
    </div>
  <% end %>
</div>
