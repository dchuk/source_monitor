<% source = form.object %>

<div class="space-y-4 rounded-lg border border-slate-200 bg-white px-5 py-5 shadow-sm">
  <div>
    <%= form.label :name, class: "block text-sm font-medium text-slate-800" %>
    <%= form.text_field :name, class: "mt-1 block w-full rounded border border-slate-300 px-3 py-2" %>
  </div>

  <div>
    <%= form.label :feed_url, class: "block text-sm font-medium text-slate-800" %>
    <%= form.url_field :feed_url, class: "mt-1 block w-full rounded border border-slate-300 px-3 py-2" %>
  </div>

  <div>
    <%= form.label :website_url, class: "block text-sm font-medium text-slate-800" %>
    <%= form.url_field :website_url, class: "mt-1 block w-full rounded border border-slate-300 px-3 py-2" %>
  </div>

  <label class="inline-flex items-center space-x-2">
    <%= form.check_box :active %>
    <span>Active</span>
  </label>
</div>

<div class="space-y-4 rounded-lg border border-slate-200 bg-white px-5 py-5 shadow-sm">
  <div>
    <%= form.label :fetch_interval_minutes, "Fetch interval (minutes)", class: "block text-sm font-medium text-slate-800" %>
    <%= form.number_field :fetch_interval_minutes, min: 1, step: 1, class: "mt-1 block w-full rounded border border-slate-300 px-3 py-2" %>
    <p class="mt-1 text-xs text-slate-500">Minimum 5 minutes recommended.</p>
  </div>

  <label class="flex items-start space-x-3 rounded-lg border border-slate-200 bg-slate-50 px-4 py-3">
    <%= form.check_box :adaptive_fetching_enabled, class: "mt-1" %>
    <span>
      <span class="block text-sm font-medium text-slate-800">Automatically adjust fetch interval</span>
      <span class="mt-1 block text-xs text-slate-500">
        When enabled, SourceMonitor lengthens or shortens the interval based on feed activity and failures. Disable to keep the interval fixed at the value above.
      </span>
    </span>
  </label>

  <div>
    <%= form.label :health_auto_pause_threshold, "Auto-pause threshold", class: "block text-sm font-medium text-slate-800" %>
    <%= form.number_field :health_auto_pause_threshold, min: 0, max: 1, step: 0.05, class: "mt-1 block w-full rounded border border-slate-300 px-3 py-2" %>
    <p class="mt-1 text-xs text-slate-500">
      Optional override for this source. When the rolling success rate falls below this fraction (defaults to <%= SourceMonitor.config.health.auto_pause_threshold %>), the source is temporarily auto-paused.
    </p>
  </div>
</div>

<div class="rounded-lg border border-slate-200 bg-white shadow-sm">
  <div class="border-b border-slate-200 px-5 py-4">
    <h2 class="text-lg font-medium">Retention</h2>
    <p class="mt-1 text-xs text-slate-500">
      Choose how long SourceMonitor keeps items for this source. Pruning runs after every fetch so the UI always reflects active retention rules.
    </p>
  </div>
  <div class="grid gap-4 px-5 py-5 sm:grid-cols-2">
    <div>
      <%= form.label :items_retention_days, "Retention window (days)", class: "block text-sm font-medium text-slate-800" %>
      <%= form.number_field :items_retention_days, min: 0, class: "mt-1 block w-full rounded border border-slate-300 px-3 py-2" %>
      <p class="mt-1 text-xs text-slate-500">
        Leave blank to keep historical items indefinitely. Items older than the configured window are removed automatically.
      </p>
    </div>

    <div>
      <%= form.label :max_items, "Maximum stored items", class: "block text-sm font-medium text-slate-800" %>
      <%= form.number_field :max_items, min: 0, class: "mt-1 block w-full rounded border border-slate-300 px-3 py-2" %>
      <p class="mt-1 text-xs text-slate-500">
        Optional hard cap. SourceMonitor keeps the newest items and prunes the rest after each fetch.
      </p>
    </div>
  </div>
</div>

<div class="rounded-lg border border-slate-200 bg-white shadow-sm">
  <div class="border-b border-slate-200 px-5 py-4">
    <h2 class="text-lg font-medium">Feed Content Processing</h2>
    <p class="mt-1 text-xs text-slate-500">Control whether feed-supplied content is cleaned with Readability before storing items.</p>
  </div>
  <div class="space-y-4 px-5 py-5">
    <label class="inline-flex items-center space-x-2">
      <%= form.check_box :feed_content_readability_enabled %>
      <span>Process feed content with Readability</span>
    </label>
    <p class="text-xs text-slate-500">
      When enabled, the raw feed HTML is passed through Readability. Scraping configuration below remains independent, so you can mix-and-match feed content and scraping strategies.
    </p>
  </div>
</div>

<% scrape_settings = (source.scrape_settings || {}).with_indifferent_access %>
<% selectors = scrape_settings[:selectors] || {} %>

<div class="rounded-lg border border-slate-200 bg-white shadow-sm">
  <div class="border-b border-slate-200 px-5 py-4">
    <h2 class="text-lg font-medium">Scraping Configuration</h2>
    <p class="mt-1 text-xs text-slate-500">Control how content extraction runs for this source.</p>
  </div>
  <div class="space-y-5 px-5 py-5">
    <div class="grid gap-3 sm:grid-cols-2">
      <label class="inline-flex items-center space-x-2">
        <%= form.check_box :scraping_enabled %>
        <span>Scraping enabled</span>
      </label>

      <label class="inline-flex items-center space-x-2">
        <%= form.check_box :auto_scrape %>
        <span>Auto scrape after fetch</span>
      </label>

      <label class="inline-flex items-center space-x-2">
        <%= form.check_box :requires_javascript %>
        <span>Requires JavaScript</span>
      </label>
    </div>

    <div>
      <%= form.label :scraper_adapter, "Scraper adapter", class: "block text-sm font-medium text-slate-800" %>
      <%= form.select :scraper_adapter, [["Readability", "readability"]], {}, class: "mt-1 block w-full rounded border border-slate-300 px-3 py-2" %>
      <p class="mt-1 text-xs text-slate-500">Additional adapters can be configured in future phases.</p>
    </div>

    <div class="grid gap-4 sm:grid-cols-2">
      <div>
        <label for="source_scrape_settings_selectors_content" class="block text-sm font-medium text-slate-800">Content CSS selector</label>
        <%= text_field_tag "source[scrape_settings][selectors][content]", selectors[:content], id: "source_scrape_settings_selectors_content", class: "mt-1 block w-full rounded border border-slate-300 px-3 py-2", placeholder: ".article-body" %>
        <p class="mt-1 text-xs text-slate-500">Optional. Overrides Readability extraction target.</p>
      </div>

      <div>
        <label for="source_scrape_settings_selectors_title" class="block text-sm font-medium text-slate-800">Title CSS selector</label>
        <%= text_field_tag "source[scrape_settings][selectors][title]", selectors[:title], id: "source_scrape_settings_selectors_title", class: "mt-1 block w-full rounded border border-slate-300 px-3 py-2", placeholder: "h1.article-title" %>
        <p class="mt-1 text-xs text-slate-500">Optional. Leave blank to use feed-provided title.</p>
      </div>
    </div>
  </div>
</div>
