<div class="space-y-6">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <h1 class="text-3xl font-semibold text-slate-900">Logs</h1>
      <p class="mt-1 text-sm text-slate-500">Review recent fetch, scrape, and health check activity in a single view.</p>
    </div>
  </div>

  <% base_params = @filter_params.except(:page) %>

  <div class="flex flex-wrap items-center gap-3">
    <div class="flex overflow-hidden rounded-md border border-slate-200">
      <% status_options = [
        ["All", nil],
        ["Successes", "success"],
        ["Failures", "failed"]
      ] %>
      <% status_options.each do |label, value| %>
        <% params_for_status = base_params.merge(status: value, page: nil).compact %>
        <% active = (@filter_set.status == value) || (@filter_set.status.nil? && value.nil?) %>
        <%= link_to label,
                    source_monitor.logs_path(params_for_status),
                    class: [
                      "px-4 py-2 text-sm font-medium border-slate-200",
                      active ? "bg-slate-800 text-white" : "bg-white text-slate-600 hover:bg-slate-50",
                      value.present? ? "border-l" : ""
                    ].join(" ") %>
      <% end %>
    </div>

    <div class="flex overflow-hidden rounded-md border border-slate-200">
      <% type_options = [
        ["All Logs", nil],
        ["Fetch Logs", "fetch"],
        ["Scrape Logs", "scrape"],
        ["Health Checks", "health_check"]
      ] %>
      <% type_options.each do |label, value| %>
        <% params_for_type = base_params.merge(log_type: value, page: nil).compact %>
        <% active = (@filter_set.log_type == value) || (@filter_set.log_type.nil? && value.nil?) %>
        <%= link_to label,
                    source_monitor.logs_path(params_for_type),
                    class: [
                      "px-4 py-2 text-sm font-medium border-slate-200",
                      active ? "bg-slate-800 text-white" : "bg-white text-slate-600 hover:bg-slate-50",
                      value.present? ? "border-l" : ""
                    ].join(" ") %>
      <% end %>
    </div>
  </div>

  <%= form_with url: source_monitor.logs_path, method: :get, local: true, html: { class: "rounded-lg border border-slate-200 bg-white p-4 shadow-sm" } do |form| %>
    <%= form.hidden_field :status, value: @filter_set.status %>
    <%= form.hidden_field :log_type, value: @filter_set.log_type %>

    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
      <div class="flex flex-col">
        <%= form.label :search, "Search logs", class: "text-xs font-semibold uppercase tracking-wide text-slate-500" %>
        <%= form.text_field :search,
                            value: @filter_set.search,
                            placeholder: "Error message, source, adapter, HTTP status…",
                            class: "mt-1 rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200" %>
      </div>

      <div class="flex flex-col">
        <%= form.label :timeframe, "Timeframe", class: "text-xs font-semibold uppercase tracking-wide text-slate-500" %>
        <%= form.select :timeframe,
                        options_for_select([["All time", nil], ["Last 24 hours", "24h"], ["Last 7 days", "7d"], ["Last 30 days", "30d"]], @filter_set.timeframe),
                        {}, class: "mt-1 rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200" %>
      </div>

      <div class="flex flex-col">
        <%= form.label :started_after, "Started after", class: "text-xs font-semibold uppercase tracking-wide text-slate-500" %>
        <%= form.datetime_field :started_after,
                                value: @filter_set.started_after&.strftime("%Y-%m-%dT%H:%M"),
                                class: "mt-1 rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200" %>
      </div>

      <div class="flex flex-col">
        <%= form.label :started_before, "Started before", class: "text-xs font-semibold uppercase tracking-wide text-slate-500" %>
        <%= form.datetime_field :started_before,
                                value: @filter_set.started_before&.strftime("%Y-%m-%dT%H:%M"),
                                class: "mt-1 rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200" %>
      </div>

      <div class="flex flex-col">
        <%= form.label :source_id, "Source ID", class: "text-xs font-semibold uppercase tracking-wide text-slate-500" %>
        <%= form.number_field :source_id,
                              value: @filter_set.source_id,
                              class: "mt-1 rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200" %>
      </div>

      <div class="flex flex-col">
        <%= form.label :item_id, "Item ID", class: "text-xs font-semibold uppercase tracking-wide text-slate-500" %>
        <%= form.number_field :item_id,
                              value: @filter_set.item_id,
                              class: "mt-1 rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200" %>
      </div>
    </div>

    <div class="mt-4 flex flex-wrap items-center gap-3">
      <%= form.submit "Search", class: "inline-flex items-center rounded-md bg-slate-800 px-4 py-2 text-sm font-medium text-white hover:bg-slate-700" %>
      <%= link_to "Clear", source_monitor.logs_path, class: "text-sm font-medium text-blue-600 hover:text-blue-500" %>
    </div>
  <% end %>

  <div class="overflow-hidden rounded-lg border border-slate-200 bg-white shadow-sm" data-testid="logs-table">
    <table class="min-w-full divide-y divide-slate-200 text-left text-sm">
      <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500">
        <tr>
          <th scope="col" class="px-6 py-3">Started</th>
          <th scope="col" class="px-6 py-3">Type</th>
          <th scope="col" class="px-6 py-3">Subject</th>
          <th scope="col" class="px-6 py-3">Source</th>
          <th scope="col" class="px-6 py-3">HTTP / Adapter</th>
          <th scope="col" class="px-6 py-3">Result</th>
          <th scope="col" class="px-6 py-3">Metrics</th>
          <th scope="col" class="px-6 py-3 text-right"></th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100 text-slate-700">
        <% @rows.each do |row| %>
          <tr class="hover:bg-slate-50" data-log-row="<%= row.dom_id %>">
            <td class="px-6 py-4 text-xs text-slate-500">
              <%= row.started_at&.strftime("%b %d, %Y %H:%M:%S") || "Unknown" %>
            </td>
            <td class="px-6 py-4 text-sm">
              <% type_classes = row.fetch? ? "bg-slate-200 text-slate-800" : "bg-blue-100 text-blue-700" %>
              <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold <%= type_classes %>"><%= row.type_label %></span>
            </td>
            <td class="px-6 py-4 text-sm">
              <% if row.primary_path %>
                <%= link_to row.primary_label, row.primary_path, class: "text-blue-600 hover:text-blue-500" %>
              <% else %>
                <%= row.primary_label %>
              <% end %>
              <% if row.url_label.present? %>
                <div class="mt-0.5 text-xs text-slate-400 truncate max-w-xs">
                  <% if row.url_href.present? %>
                    <%= external_link_to row.url_label, row.url_href, class: "text-slate-400 hover:text-blue-500" %>
                  <% else %>
                    <%= row.url_label %>
                  <% end %>
                </div>
              <% end %>
            </td>
            <td class="px-6 py-4 text-sm">
              <% if row.source_path %>
                <%= link_to row.source_label, row.source_path, class: "text-blue-600 hover:text-blue-500" %>
              <% else %>
                <%= row.source_label || "—" %>
              <% end %>
            </td>
            <td class="px-6 py-4 text-sm">
              <span class="font-medium"><%= row.http_summary %></span>
            </td>
            <td class="px-6 py-4 text-sm">
              <% status_classes = row.success? ? "bg-green-100 text-green-700" : "bg-rose-100 text-rose-700" %>
              <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold <%= status_classes %>"><%= row.status_label %></span>
              <% if row.error_message.present? %>
                <p class="mt-2 text-xs text-slate-500"><%= row.error_message %></p>
              <% end %>
            </td>
            <td class="px-6 py-4 text-xs text-slate-500">
              <%= row.metrics_summary %>
            </td>
            <td class="px-6 py-4 text-right text-sm">
              <% if row.detail_path %>
                <%= link_to "View Details", row.detail_path, class: "text-blue-600 hover:text-blue-500" %>
              <% else %>
                —
              <% end %>
            </td>
          </tr>
        <% end %>

        <% if @rows.blank? %>
          <tr>
            <td colspan="8" class="px-6 py-6 text-center text-sm text-slate-500">
              No logs recorded yet.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="flex flex-wrap items-center justify-between gap-3">
    <div class="text-xs text-slate-500" data-page-indicator="<%= @query_result.page %>">
      Page <%= @query_result.page %>
    </div>
    <div class="flex gap-2">
      <% prev_page = @query_result.has_previous_page ? @query_result.page - 1 : @query_result.page %>
      <% next_page = @query_result.has_next_page ? @query_result.page + 1 : @query_result.page %>
      <% prev_params = @filter_params.merge(page: prev_page).compact %>
      <% next_params = @filter_params.merge(page: next_page).compact %>
      <%= link_to "Previous",
                  source_monitor.logs_path(prev_params),
                  class: [
                    "inline-flex items-center rounded-md border px-3 py-1 text-sm font-medium",
                    @query_result.has_previous_page ? "border-slate-300 text-slate-700 hover:bg-slate-50" : "border-slate-200 text-slate-300 cursor-not-allowed"
                  ].join(" "),
                  aria: { disabled: !@query_result.has_previous_page } %>
      <%= link_to "Next",
                  source_monitor.logs_path(next_params),
                  class: [
                    "inline-flex items-center rounded-md border px-3 py-1 text-sm font-medium",
                    @query_result.has_next_page ? "border-slate-300 text-slate-700 hover:bg-slate-50" : "border-slate-200 text-slate-300 cursor-not-allowed"
                  ].join(" "),
                  aria: { disabled: !@query_result.has_next_page } %>
    </div>
  </div>

  <p class="text-xs text-slate-500">
    Showing up to <%= @query_result.per_page %> logs per page.
  </p>
</div>
