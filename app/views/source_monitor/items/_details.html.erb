<% item = local_assigns.fetch(:item) %>
<% source = item.source %>
<% manual_scrape_disabled = !source&.scraping_enabled? %>
<% scrape_badge = item_scrape_status_badge(item: item, source: source) %>
<% inflight_scrape = %w[pending processing].include?(scrape_badge[:status]) %>
<% recent_scrape_logs = item.scrape_logs.order(started_at: :desc).limit(5) %>
<% latest_scrape_log = recent_scrape_logs.first %>

<div class="space-y-8">
  <div class="flex flex-col justify-between gap-4 sm:flex-row sm:items-start">
    <div>
      <h1 class="text-3xl font-semibold text-slate-900"><%= item.title.presence || "(untitled)" %></h1>
      <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
        <span
          data-testid="scrape-status-badge"
          data-status="<%= scrape_badge[:status] %>"
          class="inline-flex items-center gap-1 rounded-full px-3 py-1 font-semibold <%= scrape_badge[:classes] %>"
        >
          <%= loading_spinner_svg if scrape_badge[:show_spinner] %>
          <%= scrape_badge[:label] %>
        </span>
        <% if item.scraped_at.present? %>
          <span class="rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-600">
            Last scraped <%= time_ago_in_words(item.scraped_at) %> ago
          </span>
        <% else %>
          <span class="rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-600">
            No scrape recorded
          </span>
        <% end %>
      </div>
      <p class="mt-2 text-sm text-slate-500">
        <% if source %>
          From <%= link_to source.name, source_monitor.source_path(source), class: "text-blue-600 hover:text-blue-500" %>
        <% else %>
          <span class="text-slate-400">No source</span>
        <% end %>
        &middot;
        <% if item.published_at %>
          <%= item.published_at.strftime("%b %d, %Y %H:%M %Z") %>
        <% else %>
          <span class="text-slate-400"><%= item.created_at.strftime("%b %d, %Y %H:%M %Z") %></span>
        <% end %>
      </p>
    </div>
  </div>

  <div class="grid gap-6 xl:grid-cols-3 xl:items-start">
    <div class="space-y-6 xl:col-span-1">
      <div class="rounded-lg border border-slate-200 bg-white shadow-sm">
        <div class="border-b border-slate-200 px-5 py-4">
          <h2 class="text-lg font-medium">Item Details</h2>
        </div>
        <dl class="divide-y divide-slate-100">
          <% categories_list = Array(item.categories).filter_map { |value| value.to_s.strip.presence } %>
          <% tags_list = Array(item.tags).filter_map { |value| value.to_s.strip.presence } %>
          <% details = {
               "GUID" => item.guid,
               "Content Fingerprint" => item.content_fingerprint || "—",
               "URL" => (item.url.present? ? external_link_to(item.url, item.url, class: "text-slate-900 hover:text-blue-500") : "\u2014"),
               "Canonical URL" => (item.canonical_url.present? ? external_link_to(item.canonical_url, item.canonical_url, class: "text-slate-900 hover:text-blue-500") : "\u2014"),
               "Author" => item.author || "—",
               "Published At" => (item.published_at&.strftime("%b %d, %Y %H:%M %Z") || item.created_at.strftime("%b %d, %Y %H:%M %Z")),
               "Updated At (Source)" => (item.updated_at_source&.strftime("%b %d, %Y %H:%M %Z") || "—"),
               "Language" => item.language || "—",
               "Categories" => categories_list.present? ? categories_list.join(", ") : "—",
               "Tags" => tags_list.present? ? tags_list.join(", ") : "—"
             } %>
          <% details.each do |label, value| %>
            <div class="flex items-center justify-between px-5 py-3">
              <dt class="text-sm font-medium text-slate-600"><%= label %></dt>
              <dd class="max-w-[60%] break-words text-sm text-slate-900"><%= value %></dd>
            </div>
          <% end %>
        </dl>
      </div>

      <div class="rounded-lg border border-slate-200 bg-white shadow-sm">
        <div class="border-b border-slate-200 px-5 py-4">
          <h2 class="text-lg font-medium">Scraping</h2>
          <p class="mt-1 text-xs text-slate-500">Manual results and recent adapter history.</p>
        </div>
        <div class="space-y-4 px-5 py-5 text-sm text-slate-700">
          <div class="grid gap-3 text-xs text-slate-500">
            <div class="flex justify-between">
              <span class="font-medium text-slate-600">Adapter</span>
              <span><%= source&.scraper_adapter || "—" %></span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-slate-600">HTTP Status</span>
              <span><%= latest_scrape_log&.http_status || "—" %></span>
            </div>
            <div class="flex justify-between">
              <span class="font-medium text-slate-600">Content Length</span>
              <span><%= latest_scrape_log&.content_length || "—" %></span>
            </div>
          </div>

          <% if latest_scrape_log&.error_message.present? %>
            <div class="rounded border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700">
              <p class="font-semibold">Last Error</p>
              <p class="mt-1"><%= latest_scrape_log.error_message %></p>
            </div>
          <% end %>

          <% if recent_scrape_logs.any? %>
            <div>
              <p class="text-xs font-semibold tracking-wide text-slate-500">Recent Attempts</p>
              <ul class="mt-2 space-y-2 text-xs text-slate-500">
                <% recent_scrape_logs.first(3).each do |log| %>
                  <li class="flex items-center justify-between">
                    <span><%= log.started_at&.strftime("%b %d, %H:%M") || "Unknown" %></span>
                    <span class="ml-3 inline-flex items-center rounded-full px-2 py-0.5 font-semibold <%= log.success? ? "bg-green-100 text-green-700" : "bg-rose-100 text-rose-700" %>">
                      <%= log.success? ? "Success" : "Failure" %>
                    </span>
                  </li>
                <% end %>
              </ul>
              <%= link_to "View all scrape logs", source_monitor.logs_path(log_type: "scrape", item_id: item.id), class: "mt-3 inline-block text-xs font-medium text-blue-600 hover:text-blue-500" %>
            </div>
          <% else %>
            <p class="text-xs text-slate-500">No scrape history yet.</p>
          <% end %>
        </div>
      </div>

      <div class="rounded-lg border border-slate-200 bg-white shadow-sm">
        <div class="border-b border-slate-200 px-5 py-4">
          <h2 class="text-lg font-medium">Counts &amp; Metrics</h2>
        </div>
        <div class="space-y-2 px-5 py-4 text-sm text-slate-700">
          <p><span class="font-medium text-slate-600">Comments:</span> <%= item.comments_count || 0 %></p>
          <p><span class="font-medium text-slate-600">Feed Items in Source:</span> <%= source&.items_count || "—" %></p>
        </div>
      </div>

      <div class="rounded-lg border border-slate-200 bg-white shadow-sm">
        <div class="border-b border-slate-200 px-5 py-4">
          <h2 class="text-lg font-medium">Metadata</h2>
        </div>
        <div class="px-5 py-4 text-sm text-slate-700">
          <% if item.metadata.present? %>
            <pre class="whitespace-pre-wrap break-words text-xs text-slate-600"><%= JSON.pretty_generate(item.metadata) %></pre>
          <% else %>
            <p class="text-slate-500">No metadata recorded.</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="space-y-6 xl:col-span-2">
      <div class="rounded-lg border border-slate-200 bg-white shadow-sm">
        <div class="flex flex-col gap-4 border-b border-slate-200 px-5 py-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg font-medium">Content Comparison</h2>
            <p class="mt-1 text-xs text-slate-500">Review feed-provided content alongside scraped output.</p>
          </div>
          <div class="flex flex-shrink-0 flex-wrap gap-3">
            <% if item.url.present? %>
              <%= link_to "View Original", item.url, target: "_blank", rel: "noopener", class: "inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-medium text-white shadow hover:bg-blue-500" %>
            <% end %>
            <%= button_to "Manual Scrape",
                  source_monitor.scrape_item_path(item),
                  method: :post,
                  class: [
                    "inline-flex items-center rounded-md px-3 py-2 text-sm font-medium shadow",
                    manual_scrape_disabled || inflight_scrape ? "cursor-not-allowed bg-slate-200 text-slate-500" : "bg-slate-800 text-white hover:bg-slate-700"
                  ].join(" "),
                  disabled: manual_scrape_disabled || inflight_scrape,
                  data: {
                    "async-submit-target": "button",
                    "async-submit-loading-text-value": "Queuing..."
                  },
                  form: {
                    class: "inline",
                    data: {
                      controller: "async-submit",
                      action: "turbo:submit-start->async-submit#start turbo:submit-end->async-submit#finish"
                    }
                  } %>
          </div>
        </div>
        <div class="grid gap-6 px-5 py-5 text-sm text-slate-700 lg:grid-cols-2">
          <div class="space-y-4">
            <div>
              <h3 class="text-sm font-semibold tracking-wide text-slate-500">Feed Summary</h3>
              <% if item.summary.present? %>
                <div class="mt-2 rounded border border-slate-200 bg-slate-50 p-3 text-slate-700">
                  <%= simple_format(item.summary) %>
                </div>
              <% else %>
                <p class="mt-2 text-slate-500">No summary available.</p>
              <% end %>
            </div>

            <div>
              <h3 class="text-sm font-semibold tracking-wide text-slate-500">Feed Content</h3>
              <% if item.content.present? %>
                <div class="mt-2 rounded border border-slate-200 bg-white p-3 shadow-inner">
                  <%= simple_format(item.content) %>
                </div>
              <% else %>
                <p class="mt-2 text-slate-500">No content captured from feed.</p>
              <% end %>
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <h3 class="text-sm font-semibold tracking-wide text-slate-500">Scraped Content</h3>
              <% if item.scraped_content.present? %>
                <div class="mt-2 rounded border border-emerald-200 bg-emerald-50 p-3 text-slate-700">
                  <%= simple_format(item.scraped_content) %>
                </div>
              <% else %>
                <p class="mt-2 text-slate-500">Scraper has not produced any content yet.</p>
              <% end %>
            </div>

            <div>
              <h3 class="text-sm font-semibold tracking-wide text-slate-500">Scraped HTML</h3>
              <% if item.scraped_html.present? %>
                <details class="mt-2 rounded border border-slate-200 bg-white text-xs shadow-sm">
                  <summary class="cursor-pointer px-3 py-2 font-medium text-slate-700">View raw HTML</summary>
                  <div class="px-3 pb-3 pt-2">
                    <pre class="max-h-96 overflow-auto whitespace-pre-wrap break-words text-slate-600"><%= ERB::Util.h(item.scraped_html) %></pre>
                  </div>
                </details>
              <% else %>
                <p class="mt-2 text-slate-500">No scraped HTML available.</p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
